<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <title>phocco.php</title>
        <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
    </head>
    <body>
        <div id='container'>
            <div id="background"></div>
                        <table cellspacing=0 cellpadding=0>
                <thead>
                    <tr>
                        <th class=docs><h1>phocco.php</h1></th>
                        <th class=code></th>
                    </tr>
                </thead>
                <tbody>
                                        <tr id="section-0">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-0">#</a>
                            </div>
                            
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="cp">&lt;?php</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-1">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-1">#</a>
                            </div>
                            <p>We will use [Markdown.php] (http://michelf.com/projects/php-markdown/)
 and [PHP-Optparse] (https://github.com/lelutin/php-optparse)</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="k">include_once</span><span class="p">(</span><span class="s1">&#39;libs/markdown.php&#39;</span><span class="p">);</span>
<span class="k">include_once</span><span class="p">(</span><span class="s1">&#39;libs/optparse.php&#39;</span><span class="p">);</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-2">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-2">#</a>
                            </div>
                            <p>Remote web service to highlight code</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nb">define</span> <span class="p">(</span><span class="s2">&quot;PYGMENT_WEB_SERVICE&quot;</span><span class="p">,</span> <span class="s2">&quot;http://pygments.appspot.com&quot;</span><span class="p">);</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-3">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-3">#</a>
                            </div>
                            <p>Code is run through [Pygments] (http://pygments.org/) for syntax
 highlighting. If it's not installed, locally, use a webservice</p>

<p>is Pygment presented in the local path</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nv">$envPaths</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nb">getenv</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">));</span>
<span class="nv">$isPygmentLocal</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$envPaths</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_executable</span><span class="p">(</span><span class="nv">$dir</span> <span class="o">.</span> <span class="s2">&quot;/pygmentize&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$isPygmentLocal</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$isPygmentLocal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;WARNING: Pygments not found. Using webservice&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-4">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-4">#</a>
                            </div>
                            <p>a list of languages that phocco support, mapping the file extension to
 the name of the Pygments lexer and the symbol that indicates a comment.
 To add another language to Phocco's repertoire, add it here</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nv">$languages</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;.php&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;//&#39;</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$languages</span> <span class="k">as</span> <span class="nv">$ext</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="nv">$l</span><span class="p">)</span> <span class="p">{</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-5">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-5">#</a>
                            </div>
                            <p>regex to determine the line begins with a comment</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="nv">$l</span><span class="p">[</span><span class="s2">&quot;comment_matcher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#^\\s*&quot;</span> <span class="o">.</span> <span class="nv">$l</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;#&quot;</span><span class="p">;</span>

    <span class="nv">$l</span><span class="p">[</span><span class="s2">&quot;divider_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$l</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;DIVIDER</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="nv">$l</span><span class="p">[</span><span class="s2">&quot;divider_html&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#\n*&lt;span class=&quot;c[1]?&quot;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$l</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
        <span class="o">.</span> <span class="s1">&#39;DIVIDER&lt;/span&gt;\n*#&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-6">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-6">#</a>
                            </div>
                            <p>The CSS styles we would like to apply to the documentation</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nv">$phoccoStyles</span> <span class="o">=</span> <span class="s2">&quot;phocco.css&quot;</span><span class="p">;</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-7">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-7">#</a>
                            </div>
                            <p>The start of each Pygments highlight block</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nv">$highlight_start</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&#39;</span><span class="p">;</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-8">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-8">#</a>
                            </div>
                            <p>The end of each Pygments highlight block</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="nv">$highlight_end</span> <span class="o">=</span> <span class="s1">&#39;&lt;/pre&gt;&lt;/div&gt;&#39;</span><span class="p">;</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-9">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-9">#</a>
                            </div>
                            <p>////// Main Documentation Generation Interface</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Phocco</span> <span class="p">{</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-10">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-10">#</a>
                            </div>
                            <p>Get the language of the current source file, based on extension</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLanguage</span><span class="p">(</span><span class="nv">$source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$languages</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$languages</span><span class="p">[</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))];</span>
    <span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-11">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-11">#</a>
                            </div>
                            <p>Generate documentation of a source file by reading it in, splitting it
 up into comment/code section, highlighting them for the approriate
 language, and merging them into an HTML template</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateDocumentation</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$handle</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$handle</span><span class="p">,</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$source</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">highlight</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateHtml</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
    <span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-12">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-12">#</a>
                            </div>
                            <p>Given a string of source code, parse out each comment and the code that
 follows it, and create an individual <strong>section</strong> for it
 Sections take the form:</p>

<pre><code>  array(
      "docs_text" =&gt; ...,
      "docs_html" =&gt; ...,
      "code_text" =&gt; ...,
      "code_html" =&gt; ...,
      "num" =&gt; ...
  )
</code></pre>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$code</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$lines</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$code</span><span class="p">);</span>
        <span class="nv">$sections</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$language</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLanguage</span><span class="p">(</span><span class="nv">$source</span><span class="p">);</span>
        <span class="nv">$docs_text</span> <span class="o">=</span> <span class="nv">$code_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="s2">&quot;#!&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$save</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$docs</span><span class="p">,</span> <span class="nv">$code</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$sections</span><span class="p">){</span>
            <span class="nv">$sections</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;docs_text&quot;</span> <span class="o">=&gt;</span> <span class="nv">$docs</span><span class="p">,</span>
                <span class="s2">&quot;code_text&quot;</span> <span class="o">=&gt;</span> <span class="nv">$code</span>
            <span class="p">);</span>
        <span class="p">};</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$language</span><span class="p">[</span><span class="s1">&#39;comment_matcher&#39;</span><span class="p">],</span> <span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$code_text</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$save</span><span class="p">(</span><span class="nv">$docs_text</span><span class="p">,</span> <span class="nv">$code_text</span><span class="p">);</span>
                    <span class="nv">$docs_text</span> <span class="o">=</span> <span class="nv">$code_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nv">$docs_text</span> <span class="o">.=</span> <span class="nb">preg_replace</span><span class="p">(</span>
                    <span class="nv">$language</span><span class="p">[</span><span class="s1">&#39;comment_matcher&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nv">$line</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$code_text</span> <span class="o">.=</span> <span class="nv">$line</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$save</span><span class="p">(</span><span class="nv">$docs_text</span><span class="p">,</span> <span class="nv">$code_text</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$sections</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destination</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">function</span> <span class="nf">joinPaths</span><span class="p">()</span> <span class="p">{</span>
            <span class="nv">$args</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
            <span class="nv">$paths</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$args</span> <span class="k">as</span> <span class="nv">$arg</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$paths</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$paths</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="nv">$arg</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$paths</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$path</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$paths</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$preservePaths</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">((</span><span class="nv">$lastDot</span> <span class="o">=</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="nv">$lastDot</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$filePath</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$filePath</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nv">$filePath</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">joinPaths</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s2">&quot;.html&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-13">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-13">#</a>
                            </div>
                            <p>=== Highlighting the source code ===</p>

<p>Highlights a single chunk of code using the <strong>Pygments</strong> module, and runs the
 text of its corresponding comment through <strong>Markdown</strong>.
 We process the entire file in a single call to Pygments by inserting little
 marker comments between each section and then splitting the result string
 wherever our markers occur.</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">highlight</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$sections</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$isPygmentLocal</span><span class="p">,</span> <span class="nv">$highlight_end</span><span class="p">,</span> <span class="nv">$highlight_start</span><span class="p">;</span>
        <span class="nv">$language</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLanguage</span><span class="p">(</span><span class="nv">$source</span><span class="p">);</span>
        <span class="nv">$tobePygmentize</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$sections</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$key</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$tobePygmentize</span> <span class="o">.=</span> <span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;code_text&#39;</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$tobePygmentize</span> <span class="o">.=</span> <span class="nv">$language</span><span class="p">[</span><span class="s1">&#39;divider_text&#39;</span><span class="p">]</span><span class="o">.</span><span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;code_text&#39;</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>


        <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hightlightPygmentize</span><span class="p">(</span><span class="nv">$tobePygmentize</span><span class="p">,</span>
            <span class="nv">$language</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>

        <span class="nv">$output</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nv">$highlight_start</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
        <span class="nv">$output</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="nv">$highlight_end</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
        <span class="nv">$fragments</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="nv">$language</span><span class="p">[</span><span class="s2">&quot;divider_html&quot;</span><span class="p">],</span> <span class="nv">$output</span><span class="p">);</span>

        <span class="nv">$shift</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$array</span><span class="p">,</span> <span class="nv">$default</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="nv">$val</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$sections</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$beginVal</span> <span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$fragments</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$beginVal</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="nv">$beginVal</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;code_html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$highlight_start</span> <span class="o">.</span> <span class="nv">$beginVal</span>
                <span class="o">.</span> <span class="nv">$highlight_end</span><span class="p">;</span> 
            <span class="nv">$docs_text</span> <span class="o">=</span> <span class="nb">utf8_encode</span><span class="p">(</span><span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;docs_text&#39;</span><span class="p">]);</span>
            <span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;docs_html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Markdown</span><span class="p">(</span><span class="nv">$docs_text</span><span class="p">);</span>
            <span class="nv">$section</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-14">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-14">#</a>
                            </div>
                            <p>=== HTML Code generation ===</p>

<p>Once all of the code is finished highlighting, we can generate the HTML file
 and write out the documentation. Pass the completed sections into the template
 found in <code>resources/phocco_template.php</code></p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateHtml</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$title</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$source</span><span class="p">);</span>
        <span class="nv">$dest</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>

        <span class="nv">$html</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">(</span><span class="s1">&#39;resources/phocco_template.php&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
            <span class="s1">&#39;sections&#39;</span> <span class="o">=&gt;</span> <span class="nv">$sections</span><span class="p">,</span>
            <span class="s1">&#39;sources&#39;</span> <span class="o">=&gt;</span> <span class="nv">$source</span><span class="p">,</span>
            <span class="s1">&#39;destination&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dest</span>
        <span class="p">));</span>

        <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;phocco = %s -&gt; %s </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$source</span><span class="p">,</span> <span class="nv">$dest</span><span class="p">);</span>

        <span class="nv">$pathParts</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$dest</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$pathParts</span><span class="p">[</span><span class="s1">&#39;dirname&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$pathParts</span><span class="p">[</span><span class="s1">&#39;dirname&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$pathParts</span><span class="p">[</span><span class="s1">&#39;dirname&#39;</span><span class="p">]);</span>
            <span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-15">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-15">#</a>
                            </div>
                            <p>getting ouput from view as a string</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>            <span class="nb">ob_start</span><span class="p">();</span>
            <span class="nv">$html</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">();</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span>

            <span class="nv">$handle</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$handle</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$handle</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">hightlightPygmentize</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$language</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$output</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="nv">$descriptor</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="m">0</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;pipe&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">),</span>
            <span class="m">1</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;pipe&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
            <span class="m">2</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/error-output.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$cwd</span> <span class="o">=</span> <span class="s1">&#39;/tmp&#39;</span><span class="p">;</span>

        <span class="nv">$process</span> <span class="o">=</span> <span class="nb">proc_open</span><span class="p">(</span><span class="s1">&#39;pygmentize -f html -l &#39;</span> <span class="o">.</span> <span class="nv">$language</span><span class="p">,</span> <span class="nv">$descriptor</span><span class="p">,</span>
            <span class="nv">$pipes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$process</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="nv">$source</span><span class="p">);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>

            <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>

            <span class="nb">proc_close</span><span class="p">(</span><span class="nv">$process</span><span class="p">);</span>
            <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">&quot;&lt;?php&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">,</span> <span class="nv">$count</span><span class="p">);</span>
            <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">&quot;?&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$contents</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Template</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$args</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$file</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">args</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span> <span class="o">=</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">args</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">include</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">ensureDirectory</span><span class="p">(</span><span class="nv">$directory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$directory</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$directory</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-16">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-16">#</a>
                            </div>
                            <p>The bulk of the work is done here
 For each source file passed in an argument, generate the documentation</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre><span class="k">function</span> <span class="nf">process</span><span class="p">(</span><span class="nv">$sources</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sources</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">sort</span><span class="p">(</span><span class="nv">$sources</span><span class="p">);</span>
        <span class="nx">ensureDirectory</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]);</span></pre></div></pre></div>
                        </td>
                    </tr>
                                        <tr id="section-17">
                        <td class=docs>
                            <div class="pilwrap">
                                <a class="pilcrow" href="#section-17">#</a>
                            </div>
                            <p>run the script</p>
                        </td>
                        <td class=code>
                        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nv">$phocco</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phocco</span><span class="p">;</span>
        
        <span class="k">while</span> <span class="p">(</span><span class="nv">$sources</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$phocco</span><span class="o">-&gt;</span><span class="na">generateDocumentation</span><span class="p">(</span><span class="nb">array_pop</span><span class="p">(</span><span class="nv">$sources</span><span class="p">),</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OptionParser</span><span class="p">();</span>
<span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">add_option</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--paths&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;paths&#39;</span><span class="p">));</span>
<span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">add_option</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--directory&#39;</span><span class="p">,</span> <span class="s1">&#39;dest&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span>
    <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">));</span>

<span class="nv">$options</span> <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">parse_args</span><span class="p">(</span><span class="nv">$argv</span><span class="p">);</span>

<span class="nx">process</span><span class="p">(</span><span class="nv">$options</span><span class="o">-&gt;</span><span class="na">positional</span><span class="p">,</span> <span class="nv">$options</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>

</pre></div></pre></div>
                        </td>
                    </tr>
                                </table>
        </div>
    </body>
</html>
